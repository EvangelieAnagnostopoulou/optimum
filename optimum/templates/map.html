{% extends "base.html" %}

{% block content %}
<div id="right-panel" style="height:500px;float: right;width:50%;overflow: auto;">
    <div style="float:left;left:100%;width:30%;">
        <h6><b> Duration of your route:</b></h6>
        <input type="text" id="duration" class="form-control" style="width:50%;">
    </div>
    <div style="float:left;">
        <h6><b> C02 emissions of route:</b></h6>
        <input type="text" id="emissions" class="form-control" style="width:70%;">
    </div>
     <div style="left:10%">
        <h6><b> Cost:</b></h6>
        <input type="text" id="cost" class="form-control" style="width:20%;">
    </div>

    <ul class="nav nav-tabs">
      <li class="active"><a href="#home" data-toggle="tab" aria-expanded="true" style="color:blue;">Transit</a></li>
      <li class=""><a href="#profile" data-toggle="tab" aria-expanded="false" style="color:green;">Driving</a></li>
    </ul>
    <div id="myTabContent" class="tab-content">
      <div class="tab-pane fade active in" id="home">
          <div style="float:right; width:20%">
            <p><b>CO2 emissions</b></p>
            <h4 style="margin-top:15px;margin-left:25px;">
                <div class="progress" style="width:50%;margin:0px;">
                  <div id="em0" class="progress-bar progress-bar-success" style="width: 50%"></div>
                </div>
                <div class="progress" style="width:50%;margin-top:1px;">
                  <div id="em_track0" class="progress-bar progress-bar-danger" style="width: 100%"></div>
                </div>
            </h4>
            <h4 style="margin-top:-18px;margin-left:25px;">
                <div class="progress" style="width:50%;margin:0px;">
                  <div id="em1" class="progress-bar progress-bar-success" style="width: 50%"></div>
                </div>
                <div class="progress" style="width:50%;margin-top:1px;">
                  <div id="em_track1" class="progress-bar progress-bar-danger" style="width: 100%"></div>
                </div>
            </h4>
            <h4 style="margin-top:-15px; margin-bottom:14px;margin-left:25px;">
                <div class="progress" style="width:50%;margin:0px;">
                  <div id="em2" class="progress-bar progress-bar-success" style="width: 50%"></div>
                </div>
                <div class="progress" style="width:50%;margin-top:1px;">
                  <div id="em_track2" class="progress-bar progress-bar-danger" style="width: 100%"></div>
                </div>
            </h4>
            <h4 style="margin-top:-18px; margin-bottom:14px;margin-left:25px;">
                <div class="progress" style="width:50%;margin:0px;">
                  <div id="em3" class="progress-bar progress-bar-success" style="width: 50%"></div>
                </div>
                <div class="progress" style="width:50%;margin-top:1px;">
                  <div id="em_track3" class="progress-bar progress-bar-danger" style="width: 100%"></div>
                </div>
            </h4>
              </div>
      </div>

      <div class="tab-pane fade" id="profile">

          <div style="float:right; width:20%">
            <p><b>CO2 emissions</b></p>
            <p style="margin-top:15px;margin-left:25px;">
                <div class="progress" style="width:30%;margin:0px;float:left;">
                  <div id="dr_em0" class="progress-bar progress-bar-success" style="width: 95%"></div>
                </div>
                <div class="progress" style="width:30%;margin-top:1px;">
                  <div id="em_dr_track0" class="progress-bar progress-bar-danger" style="width: 100%"></div>
                </div>
            </p>
            <p style="margin-top:-18px;margin-left:25px;">
                <div class="progress" style="width:30%;margin:0px;float:left;">
                  <div id="dr_em1" class="progress-bar progress-bar-success" style="width: 95%"></div>
                </div>
                <div class="progress" style="width:30%;margin-top:1px;">
                  <div id="em_dr_track1" class="progress-bar progress-bar-danger" style="width: 100%"></div>
                </div>
            </p>
              </div>
          <div id="drive" style="float:right; width:80%"></div>

      </div>
    </div>


</div>

<div id="map" style="width: 50%; height: 500px;">

</div>
<!--<div id="driving" style="float:left;width:40%;overflow: auto;">



</div> -->
<!--<div style="float:left;left:40%;width:15%;height: 200px;overflow: auto;">

        <div>
        <p><b>CO2 emissions</b></p>
        <p id="dr_em0"></p>
        <p id="dr_em1"></p>
            </div>


</div> -->

 <!--<script src="https://maps.googleapis.com/maps/api/js?language=en"></script>    -->
 <script src="static/js/loadgpx.js" type="text/javascript"></script>
    <script>
        function loadGPXFileIntoGoogleMap(map, filename, callback, m, distance) {
                $.ajax({url: filename,
                    dataType: "xml",
                    success: function(data) {
                      var parser = new GPXParser(data, map);
                      parser.setTrackColour("#ff0000");     // Set the track line colour
                      parser.setTrackColour("#ff0000");     // Set the track line colour
                      parser.setTrackWidth(5);          // Set the track line width
                      parser.setMinTrackPointDelta(0.001);      // Set the minimum distance between track points
                      parser.centerAndZoom(data);
                      parser.addTrackpointsToMap();         // Add the trackpoints
                      parser.addWaypointsToMap();           // Add the waypoints
                      var points = parser.getorigin(data);
                      var mode = parser.get_mode(data);
                      if (mode == "οδήγηση"){
                            mode = 'DRIVING'
                            }
                      if (mode == "συγκοινωνιες"){
                            mode = 'TRANSIT'
                            }
                      var track_distance = parser.CalculateDistance(data);
                      callback(points, mode, track_distance)



                    }
                });
            }
            $(document).ready(function() {
                var mapOptions = {
                  zoom: 8,
                  mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                 var mDirectionsRendererOptions = {
                        polylineOptions: {strokeColor:'green'}
                };

                var directionsDisplay = new google.maps.DirectionsRenderer;
                var directionsDisplay1 = new google.maps.DirectionsRenderer(mDirectionsRendererOptions);
                var directionsService = new google.maps.DirectionsService;
                var map = new google.maps.Map(document.getElementById("map"),mapOptions);
                loadGPXFileIntoGoogleMap(map, "/path?file={{file}}", get_points);



                function get_points(points, mode, distance) {

                    directionsDisplay.setMap(map);
                    directionsDisplay1.setMap(map);
                    directionsDisplay.setPanel(document.getElementById('home'));
                    directionsDisplay1.setPanel(document.getElementById('drive'));
                    calculateAndDisplayRoute(directionsService, directionsDisplay, points, mode, distance);
                }

                function calculateAndDisplayRoute(directionsService, directionsDisplay, points, mode, distance) {

                      var start = new google.maps.LatLng(points[0],points[1]);
                      var end = new google.maps.LatLng(points[2], points[3]);

                      $('#duration').val(points[4]);

                      //calculate C02 emissions for track if mode is driving
                      if( mode== 'DRIVING'){
                        track_emissions = (distance/1000)*169;
                        track_emissions = track_emissions.toFixed(2);
                         $('#emissions').val(track_emissions);

                         //calculate cost
                         var cost=1.4*7.5*(distance/1000)/100;
                         cost = cost.toFixed(2);
                         $('#cost').val(cost);

                      }

                      if (mode == 'DRIVING'){
                        var travel = google.maps.TravelMode.TRANSIT
                      }
                      else{
                        var travel = google.maps.TravelMode.DRIVING
                      }

                      directionsService.route({
                        origin: start,
                        destination: end,
                        travelMode: travel,
                        transitOptions: {
                            departureTime: new Date("August 08, 2015 11:00"),
                            },
                        provideRouteAlternatives: true,

                      }, function(response, status) {
                        if (status === google.maps.DirectionsStatus.OK) {

                          //get distance and travel_mode and calculate CO2 for suggested routes
                            calculate_emissions(response, "TRANSIT", track_emissions);
                            directionsDisplay.setDirections(response);

                        } else {
                              window.alert('Directions request failed due to ' + status);
                            }
                         }
                        );

                      directionsService.route({
                        origin: start,
                        destination: end,
                        travelMode: google.maps.TravelMode.DRIVING,
                        provideRouteAlternatives: true,
                      }, function(response1, status) {
                        if (status === google.maps.DirectionsStatus.OK) {
                          //get distance and travel_mode and calculate CO2 for suggested routes
                          var em = calculate_emissions(response1, "DRIVING", track_emissions);
                          directionsDisplay1.setDirections(response1);
                        } else {
                          window.alert('Directions request failed due to ' + status);
                        }
                      });

                }

                 function calculate_emissions(response, mode, track_emissions) {
                    for (var i in response.routes) {
                        emissions=0
                        for (var j in  response.routes[i].legs[0].steps){
                            var distance = response.routes[i].legs[0].steps[j].distance.value
                            var travel_mode = response.routes[i].legs[0].steps[j].travel_mode
                            if (travel_mode =="TRANSIT"){
                                travel_mode =  response.routes[i].legs[0].steps[j].transit.line.vehicle.type;
                            }
                            emissions = emissions + calculate(distance, travel_mode)
                        }
                        em=[]
                        em[i]= emissions
                        if (mode == "TRANSIT"){
                            for (var i=0; i<em.length; i++ ){
                                $('#em'+i).text(em[i]);
                                $('#em_track'+i).text(track_emissions);
                            }
                        }
                        if (mode == "DRIVING"){
                            for (var i=0; i<em.length; i++ ){
                                $('#dr_em'+i).text(em[i]);
                                $('#em_dr_track'+i).text(track_emissions);
                                //$("td.adp-listsel").append("em[i]");
                            }

                        }


                    }

                function calculate(distance, travel_mode){
                    var emissions = 0;
                    if (travel_mode == "WALKING"){
                        var emissions = 0;
                    }
                    if (travel_mode == "BIKE"){
                        var emissions = 0;
                    }
                    if (travel_mode == "SUBWAY"){
                        var emissions = (distance/1000)*20;
                    }
                    if (travel_mode == "HEAVY_RAIL"){
                        var emissions = (distance/1000)*50;
                    }
                    if (travel_mode == "BUS"){
                        var emissions = (distance/1000)*25.5;
                    }
                    if (travel_mode == "DRIVING"){
                        var emissions = (distance/1000)*110;
                    }
                    return emissions

                }




                }


              });
      $(window).load(function() {
     //Hide details direction after page is fully loaded in background.
     $('.adp').hide();
    });



    </script>




{% endblock%}